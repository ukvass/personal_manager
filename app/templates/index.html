<!-- >>> PATCH: app/templates/index.html
# Что изменилось:
# - УБРАНА обёртка <form action="/ui/bulk_delete"> вокруг таблицы (исключаем вложенные формы).
# - Добавлена отдельная пустая форма <form id="bulk-form" action="/ui/bulk_delete">.
# - Чекбоксы строк теперь с атрибутом form="bulk-form", name="ids".
# - Кнопка "Bulk delete" привязана к этой форме атрибутом form="bulk-form".
# - Email пользователя выводится в шапке через base.html (контекст user_email уже передаётся из web.py).
-->
{% extends "base.html" %}
{% block title %}Tasks · Personal Manager{% endblock %}
{% block content %}
  <section class="card">
    <h2>Create task</h2>
    <form method="post" action="/ui/tasks" class="grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
      <label>Title
        <input name="title" required maxlength="120">
      </label>
      <label>Priority
        <input name="priority" type="number" min="1" max="5" value="1">
      </label>
      <div class="actions">
        <button class="btn btn-primary" type="submit">Add</button>
      </div>
    </form>
  </section>

  <section class="card">
    <h2>Filter</h2>
    <form method="get" action="/" class="grid">
      <label>Search
        <input name="q" value="{{ q }}">
      </label>
      <label>Status
        <select name="status">
          <option value="" {{ (status or '') == '' and 'selected' or '' }}>Any</option>
          <option value="todo" {{ (status or '') == 'todo' and 'selected' or '' }}>Todo</option>
          <option value="in_progress" {{ (status or '') == 'in_progress' and 'selected' or '' }}>In progress</option>
          <option value="done" {{ (status or '') == 'done' and 'selected' or '' }}>Done</option>
        </select>
      </label>
      <label>Priority
        <input name="priority" type="number" min="1" max="5" value="{{ priority if priority is not none else '' }}">
      </label>
      <label>Order by
        <select name="order_by">
          <option value="created_at" {{ order_by == 'created_at' and 'selected' or '' }}>Created</option>
          <option value="priority"   {{ order_by == 'priority'   and 'selected' or '' }}>Priority</option>
          <option value="status"     {{ order_by == 'status'     and 'selected' or '' }}>Status</option>
          <option value="deadline"   {{ order_by == 'deadline'   and 'selected' or '' }}>Deadline</option>
        </select>
      </label>
      <label>Order dir
        <select name="order_dir">
          <option value="desc" {{ order_dir == 'desc' and 'selected' or '' }}>Desc</option>
          <option value="asc"  {{ order_dir == 'asc'  and 'selected' or '' }}>Asc</option>
        </select>
      </label>
      <div class="actions">
        <button class="btn" type="submit">Apply</button>
      </div>
    </form>
  </section>

  <section class="card card-compact">
    <h2>Tasks ({{ total }})</h2>

    {% if (q and q|length) or status or priority is not none %}
      <div class="chips">
        {% if q and q|length %}
          <a class="chip" href="/?q=&status={{ status|default('') }}&priority={{ priority if priority is not none else '' }}&order_by={{ order_by }}&order_dir={{ order_dir }}&limit={{ limit }}&offset=0">q: {{ q }} ×</a>
        {% endif %}
        {% if status %}
          <a class="chip" href="/?q={{ q }}&status=&priority={{ priority if priority is not none else '' }}&order_by={{ order_by }}&order_dir={{ order_dir }}&limit={{ limit }}&offset=0">status: {{ status }} ×</a>
        {% endif %}
        {% if priority is not none %}
          <a class="chip" href="/?q={{ q }}&status={{ status|default('') }}&priority=&order_by={{ order_by }}&order_dir={{ order_dir }}&limit={{ limit }}&offset=0">priority: {{ priority }} ×</a>
        {% endif %}
        <a class="chip chip-muted" href="/?order_by={{ order_by }}&order_dir={{ order_dir }}&limit={{ limit }}&offset=0">Clear all</a>
      </div>
    {% endif %}

    

    <!-- table body WITHOUT outer form (to avoid nested forms) -->
    <div class="table">
      <div class="row header">
        <div></div>
        <div>
          {% set dir = (order_dir == 'desc' and 'asc' or 'desc') if order_by == 'created_at' else 'desc' %}
          <a href="/?q={{ q }}&status={{ status or '' }}&priority={{ priority if priority is not none else '' }}&order_by=created_at&order_dir={{ dir }}&limit={{ limit }}&offset=0">ID{% if order_by == 'created_at' %} {{ order_dir == 'asc' and '▲' or '▼' }}{% endif %}</a>
        </div>
        <div>Title</div>
        <div>
          {% set dir = (order_dir == 'desc' and 'asc' or 'desc') if order_by == 'status' else 'desc' %}
          <a href="/?q={{ q }}&status={{ status or '' }}&priority={{ priority if priority is not none else '' }}&order_by=status&order_dir={{ dir }}&limit={{ limit }}&offset=0">Status{% if order_by == 'status' %} {{ order_dir == 'asc' and '▲' or '▼' }}{% endif %}</a>
        </div>
        <div>
          {% set dir = (order_dir == 'desc' and 'asc' or 'desc') if order_by == 'priority' else 'desc' %}
          <a href="/?q={{ q }}&status={{ status or '' }}&priority={{ priority if priority is not none else '' }}&order_by=priority&order_dir={{ dir }}&limit={{ limit }}&offset=0">Priority{% if order_by == 'priority' %} {{ order_dir == 'asc' and '▲' or '▼' }}{% endif %}</a>
        </div>
        <div>Actions</div>
      </div>

      {% for t in tasks %}
        <div class="row">
          <div>
            <input class="chk" type="checkbox" form="bulk-form" name="ids" value="{{ t.id }}">
          </div>
          <div>{{ t.id }}</div>

          {% include "partials/title_cell.html" %}
          {% include "partials/status_cell.html" %}
          {% include "partials/priority_cell.html" %}

          <div class="row-actions">
            <form method="post" action="/ui/tasks/{{ t.id }}/delete" class="inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
              <button class="btn btn-danger" type="submit">Delete</button>
            </form>
          </div>
        </div>
      {% else %}
        <p class="muted">No tasks match your filters.</p>
      {% endfor %}
    </div>

    

    <!-- separate forms for bulk actions -->
    <form id="bulk-form" method="post" action="/ui/bulk_delete">
      <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
    </form>

    <div class="card-footer">
      <div class="actions">
        <button class="btn btn-danger" form="bulk-form" type="submit">Bulk delete</button>
        <form method="post" action="/ui/bulk_complete">
          <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
          {% for t in tasks %}
            <input type="hidden" name="ids" value="{{ t.id }}">
          {% endfor %}
          <button class="btn btn-success" type="submit">Mark all on page as done</button>
        </form>
      </div>
      
    </div>
  </section>
{% endblock %}
