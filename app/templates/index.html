<!-- >>> PATCH: app/templates/index.html
# Что изменилось:
# - УБРАНА обёртка <form action="/ui/bulk_delete"> вокруг таблицы (исключаем вложенные формы).
# - Добавлена отдельная пустая форма <form id="bulk-form" action="/ui/bulk_delete">.
# - Чекбоксы строк теперь с атрибутом form="bulk-form", name="ids".
# - Кнопка "Bulk delete" привязана к этой форме атрибутом form="bulk-form".
# - Email пользователя выводится в шапке через base.html (контекст user_email уже передаётся из web.py).
-->
{% extends "base.html" %}
{% block title %}Tasks · Personal Manager{% endblock %}
{% block content %}
  <section class="card">
    <h2>Create task</h2>
    <form method="post" action="/ui/tasks" class="grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
      <label>Title
        <input name="title" required maxlength="120">
      </label>
      <label>Priority
        <input name="priority" type="number" min="1" max="5" value="1">
      </label>
      <div class="actions">
        <button class="btn btn-primary" type="submit">Add</button>
      </div>
    </form>
  </section>

  <section class="card">
    <h2>Filter</h2>
    <form method="get" action="/" class="grid">
      <label>Search
        <input name="q" value="{{ q }}">
      </label>
      <label>Status
        <select name="status">
          <option value="" {{ (status or '') == '' and 'selected' or '' }}>Any</option>
          <option value="todo" {{ (status or '') == 'todo' and 'selected' or '' }}>Todo</option>
          <option value="in_progress" {{ (status or '') == 'in_progress' and 'selected' or '' }}>In progress</option>
          <option value="done" {{ (status or '') == 'done' and 'selected' or '' }}>Done</option>
        </select>
      </label>
      <label>Priority
        <input name="priority" type="number" min="1" max="5" value="{{ priority if priority is not none else '' }}">
      </label>
      <label>Order by
        <select name="order_by">
          <option value="created_at" {{ order_by == 'created_at' and 'selected' or '' }}>Created</option>
          <option value="priority"   {{ order_by == 'priority'   and 'selected' or '' }}>Priority</option>
          <option value="status"     {{ order_by == 'status'     and 'selected' or '' }}>Status</option>
          <option value="deadline"   {{ order_by == 'deadline'   and 'selected' or '' }}>Deadline</option>
        </select>
      </label>
      <label>Order dir
        <select name="order_dir">
          <option value="desc" {{ order_dir == 'desc' and 'selected' or '' }}>Desc</option>
          <option value="asc"  {{ order_dir == 'asc'  and 'selected' or '' }}>Asc</option>
        </select>
      </label>
      <div class="actions">
        <button class="btn" type="submit">Apply</button>
      </div>
    </form>
  </section>

  <section class="card card-compact">
    <h2>Tasks ({{ total }})</h2>

    <!-- table body WITHOUT outer form (to avoid nested forms) -->
    <div class="table">
      <div class="row header">
        <div></div>
        <div>ID</div>
        <div>Title</div>
        <div>Status</div>
        <div>Priority</div>
        <div>Actions</div>
      </div>

      {% for t in tasks %}
        <div class="row">
          <div>
            <input class="chk" type="checkbox" form="bulk-form" name="ids" value="{{ t.id }}">
          </div>
          <div>{{ t.id }}</div>

          {% include "partials/title_cell.html" %}
          {% include "partials/status_cell.html" %}
          {% include "partials/priority_cell.html" %}

          <div class="row-actions">
            <form method="post" action="/ui/tasks/{{ t.id }}/delete" class="inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
              <button class="btn btn-danger" type="submit">Delete</button>
            </form>
          </div>
        </div>
      {% else %}
        <p class="muted">No tasks match your filters.</p>
      {% endfor %}
    </div>

    <!-- separate forms for bulk actions -->
    <form id="bulk-form" method="post" action="/ui/bulk_delete">
      <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
    </form>

    <div class="actions">
      <button class="btn btn-danger" form="bulk-form" type="submit">Bulk delete</button>
      <form method="post" action="/ui/bulk_complete">
        <input type="hidden" name="csrf_token" value="{{ csrf_token or '' }}">
        {% for t in tasks %}
          <input type="hidden" name="ids" value="{{ t.id }}">
        {% endfor %}
        <button class="btn btn-success" type="submit">Mark all on page as done</button>
      </form>
    </div>
  </section>
{% endblock %}
